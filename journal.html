<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="TradeBlitz Dashboard - Trade Journal">
    <title>Journal | TradeBlitz Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;600;800&display=swap"
        rel="stylesheet">
</head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<body>
    <div class="glow-orb orb-1"></div>
    <div class="glow-orb orb-2"></div>
    <div class="grid-overlay"></div>

    <nav id="navbar" class="scrolled">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-text">TradeBlitz Dashboard</span>
            </div>
            <div class="nav-links">
                <a href="prep.html">Daily Prep</a>
                <a href="execute.html">Execute</a>
                <a href="journal.html" class="active" style="color: #fff;">Journal</a>
                <a href="tradingclass.html">Trading Class</a>
                <a href="chat.html">AI Chat</a>
            </div>
            <a href="index.html" class="btn-nav">Log Out</a>
        </div>
    </nav>

    <section class="routine-section" style="padding-top: 10rem; min-height: 100vh;">
        <div class="container">
            <h2 class="section-title">Trade Journal üìñ</h2>
            <p class="section-subtitle">Log your trades, document your setups, and track your psychology.</p>

            <div class="dashboard-grid"
                style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-top: 3rem;">

                <!-- Log Trade Form -->
                <div class="glass-panel"
                    style="padding: 2.5rem; border-radius: 16px; background: #0b0d17; border-top: 4px solid #3b82f6;">
                    <h3
                        style="font-size: 1.5rem; color: #fff; margin-bottom: 1.5rem; font-family: var(--font-heading);">
                        <span style="margin-right:0.5rem">‚úçÔ∏è</span> New Entry
                    </h3>

                    <form id="journalForm" style="display: flex; flex-direction: column; gap: 1.2rem;">
                        <div>
                            <label
                                style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Date</label>
                            <input type="date" id="tradeDate" required
                                style="width:100%; padding: 0.8rem; background: #05060a; border: 1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; outline: none; margin-top: 0.3rem;">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label
                                    style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Pair</label>
                                <select id="tradePair"
                                    style="width:100%; padding: 0.8rem; background: #05060a; border: 1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; outline: none; margin-top: 0.3rem;">
                                    <option value="XAUUSD">XAUUSD</option>
                                    <option value="EURUSD">EURUSD</option>
                                    <option value="GBPUSD">GBPUSD</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Direction</label>
                                <select id="tradeDirection"
                                    style="width:100%; padding: 0.8rem; background: #05060a; border: 1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; outline: none; margin-top: 0.3rem;">
                                    <option value="LONG">Long (Buy)</option>
                                    <option value="SHORT">Short (Sell)</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label
                                    style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Trend</label>
                                <select id="tradeSetup"
                                    style="width:100%; padding: 0.8rem; background: #05060a; border: 1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; outline: none; margin-top: 0.3rem;">
                                    <option value="Up">Up</option>
                                    <option value="Down">Down</option>
                                    <option value="Sideways">Sideways</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Result</label>
                                <select id="tradeResult"
                                    style="width:100%; padding: 0.8rem; background: #05060a; border: 1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; outline: none; margin-top: 0.3rem;">
                                    <option value="WIN">Win</option>
                                    <option value="LOSS">Loss</option>
                                    <option value="BE">Break Even</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label
                                    style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">R:R
                                    Achieved</label>
                                <input type="number" step="0.1" id="tradeRR" placeholder="e.g. 2.5"
                                    style="width:100%; padding: 0.8rem; background: #05060a; border: 1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; outline: none; margin-top: 0.3rem;">
                            </div>
                            <div>
                                <label
                                    style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">P&L
                                    ($)</label>
                                <input type="number" step="0.01" id="tradePnL" placeholder="e.g. 250"
                                    style="width:100%; padding: 0.8rem; background: #05060a; border: 1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; outline: none; margin-top: 0.3rem;">
                            </div>
                        </div>

                        <!-- Removed Chart Screenshot Link -->

                        <div>
                            <label
                                style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Trade
                                Notes & Psychology</label>
                            <textarea id="tradeNotes" rows="4" placeholder="How did you feel? Did you follow your plan?"
                                style="width:100%; padding: 0.8rem; background: #05060a; border: 1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; outline: none; margin-top: 0.3rem; resize: vertical; font-family: 'Inter', sans-serif;"></textarea>
                        </div>

                        <button type="submit"
                            style="background: #3b82f6; color: #fff; font-weight: 800; font-size: 1.1rem; padding: 1rem; border: none; border-radius: 8px; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; margin-top: 1rem;">
                            Save Trade Run
                        </button>
                    </form>
                </div>

                <!-- Recent Logs Display -->
                <div class="glass-panel"
                    style="padding: 2.5rem; border-radius: 16px; background: #0b0d17; display: flex; flex-direction: column;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1.5rem; color: #fff; font-family: var(--font-heading);">
                            <span style="margin-right:0.5rem">üìä</span> Recent Logs
                        </h3>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <button id="downloadCsvBtn"
                                style="background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.4); padding: 0.4rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; transition: background 0.3s ease;">
                                <span>üì•</span> Save CSV
                            </button>
                            <span
                                style="color: #64748b; font-size: 0.9rem; background: #12141f; padding: 0.4rem 0.8rem; border-radius: 6px;">Total
                                Logged: <strong id="logCount" style="color:#fff;">0</strong></span>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div
                            style="background: #12141f; padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <div
                                style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; margin-bottom: 0.5rem;">
                                Win Rate</div>
                            <div style="width: 120px; height: 120px; position: relative;">
                                <canvas id="winRateChart"></canvas>
                                <div id="winRateText"
                                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-weight: 800; font-size: 1.2rem;">
                                    0%</div>
                            </div>
                        </div>
                        <div
                            style="background: #12141f; padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; justify-content: center;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.8rem;">
                                <span
                                    style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Total
                                    Trades</span>
                                <span style="color: #fff; font-weight: 800;" id="dashTotalTrades">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.8rem;">
                                <span
                                    style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Total
                                    P&L</span>
                                <span style="color: #fff; font-weight: 800;" id="dashTotalPnl">$0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span
                                    style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Wins
                                    / Losses</span>
                                <span style="color: #fff; font-weight: 600;"><span style="color:#10b981"
                                        id="dashWins">0</span> / <span style="color:#ef4444"
                                        id="dashLosses">0</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Equity Curve Section -->
                    <div
                        style="background: #12141f; padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 1.5rem;">
                        <h4
                            style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; margin-bottom: 1rem;">
                            Cumulative P&L (Equity Curve)</h4>
                        <div style="width: 100%; height: 250px; position: relative;">
                            <canvas id="equityChart"></canvas>
                        </div>
                    </div>

                    <!-- AI Insight Section -->
                    <div
                        style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.15)); border: 1px solid rgba(139, 92, 246, 0.3); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: flex-start;">
                        <div style="font-size: 1.8rem; filter: drop-shadow(0 0 8px rgba(139, 92, 246, 0.5));">‚ú®</div>
                        <div>
                            <h4
                                style="color: #c4b5fd; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; font-weight: 800;">
                                TradeBlitz AI Insight</h4>
                            <p id="aiInsightText"
                                style="color: #f8fafc; font-size: 0.95rem; line-height: 1.5; font-weight: 500;">
                                Log at least 3 trades for the AI to analyze your performance and identify patterns.
                            </p>
                        </div>
                    </div>

                    <div id="logsContainer"
                        style="display: flex; flex-direction: column; gap: 1rem; overflow-y: auto; max-height: 600px; padding-right: 0.5rem;">

                        <!-- Empty State -->
                        <div id="emptyState" style="text-align: center; padding: 4rem 1rem; color: #64748b;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                            <h4 style="color: #94a3b8; margin-bottom: 0.5rem;">No trades logged yet.</h4>
                            <p style="font-size: 0.9rem;">Start recording your edges using the form on the left.</p>
                        </div>

                        <!-- Logs will be injected here via JS -->

                    </div>
                </div>

            </div>
        </div>
    </section>

    <script>
        // Set default date to today
        document.getElementById('tradeDate').valueAsDate = new Date();

        const journalForm = document.getElementById('journalForm');
        const logsContainer = document.getElementById('logsContainer');
        const emptyState = document.getElementById('emptyState');
        const logCount = document.getElementById('logCount');

        const userEmail = localStorage.getItem('tradeblitz_user_email') || 'guest';
        const storageKey = `tradeblitz_journal_${userEmail}`;

        // Simple local storage usage, with migration from old global key if exists
        let trades = JSON.parse(localStorage.getItem(storageKey));
        if (!trades) {
            let oldTrades = JSON.parse(localStorage.getItem('tradeblitz_journal'));
            if (oldTrades && oldTrades.length > 0) {
                trades = oldTrades;
                localStorage.setItem(storageKey, JSON.stringify(trades));
            } else {
                trades = [];
            }
        }

        let winRateChart = null;
        let equityChart = null;

        function updateDashboard() {
            const total = trades.length;
            const wins = trades.filter(t => t.result === 'WIN').length;
            const losses = trades.filter(t => t.result === 'LOSS').length;
            const be = trades.filter(t => t.result === 'BE').length;

            // Pre-process computed P&L so the chart always reflects wins/losses correctly
            trades.forEach(t => {
                let pnl = parseFloat(t.pnl);
                if (isNaN(pnl) || pnl === 0) {
                    // If no P&L provided, default to $100 per R or flat $100 to still show movement
                    let rr = parseFloat(t.rr);
                    pnl = (!isNaN(rr) && rr > 0) ? (rr * 100) : 100;
                }

                if (t.result === 'LOSS') {
                    t.computedPnl = -Math.abs(pnl);
                } else if (t.result === 'WIN') {
                    t.computedPnl = Math.abs(pnl);
                } else {
                    t.computedPnl = 0; // Break Even
                }
            });

            let totalPnl = 0;
            trades.forEach(t => {
                totalPnl += t.computedPnl;
            });

            document.getElementById('dashTotalTrades').innerText = total;
            document.getElementById('dashWins').innerText = wins;
            document.getElementById('dashLosses').innerText = losses;

            const pnlEl = document.getElementById('dashTotalPnl');
            pnlEl.innerText = (totalPnl >= 0 ? '+$' : '-$') + Math.abs(totalPnl).toFixed(2);
            pnlEl.style.color = totalPnl >= 0 ? '#10b981' : '#ef4444';

            // Winrate calculation (excluding break evens from total for precision)
            const trueTotal = wins + losses;
            const winRate = trueTotal > 0 ? Math.round((wins / trueTotal) * 100) : 0;
            document.getElementById('winRateText').innerText = winRate + '%';

            // Generate AI Insight
            const aiInsightText = document.getElementById('aiInsightText');
            if (aiInsightText) {
                if (trueTotal < 3) {
                    aiInsightText.innerText = "Log at least 3 trades for the AI to analyze your performance and identify patterns.";
                } else {
                    let pairStats = {};
                    trades.forEach(t => {
                        if (!pairStats[t.pair]) pairStats[t.pair] = { wins: 0, losses: 0, pnl: 0 };
                        if (t.result === 'WIN') pairStats[t.pair].wins++;
                        if (t.result === 'LOSS') pairStats[t.pair].losses++;
                        if (t.pnl) pairStats[t.pair].pnl += parseFloat(t.pnl);
                    });

                    let bestPair = null;
                    let worstPair = null;
                    let highestPnL = -Infinity;
                    let lowestPnL = Infinity;

                    for (let pair in pairStats) {
                        let p = pairStats[pair];
                        if (p.pnl > highestPnL && p.wins >= 1) { highestPnL = p.pnl; bestPair = pair; }
                        if (p.pnl < lowestPnL && p.losses >= 1) { lowestPnL = p.pnl; worstPair = pair; }
                    }

                    let insight = "";

                    if (winRate >= 60 && totalPnl > 0) {
                        insight = "Solid performance! You maintain a high win rate with positive expectancy. <strong>Keep executing your current edge.</strong>";
                    } else if (winRate < 45 && totalPnl < 0) {
                        insight = "Your win rate and P&L are low. <strong>Consider reducing your position size</strong> and reviewing your setups to protect capital.";
                    } else if (winRate < 50 && totalPnl > 0) {
                        insight = "Your R:R is carrying your profitability despite a lower win rate. <strong>Great risk management</strong>‚Äîkeep stop losses tight!";
                    } else if (winRate >= 50 && totalPnl < 0) {
                        insight = "You win often, but lose money overall. <strong>Analyze your R:R</strong>‚Äîyou may be cutting winners early or letting losers run.";
                    } else if (totalPnl > 0) {
                        insight = "Steady performance. You are consistently profitable overall. Keep journaling your psychology.";
                    } else {
                        insight = "You're in a bit of a drawdown. Stick to your A+ setups and avoid revenge trading.";
                    }

                    if (bestPair && highestPnL > 0 && worstPair && lowestPnL < 0 && bestPair !== worstPair) {
                        insight += ` <br><span style="color:#d8b4fe; display:inline-block; margin-top:0.4rem;">üí° AI Notes: You perform best on <strong>${bestPair}</strong>, but are losing capital on <strong>${worstPair}</strong>. Focus on your strength!</span>`;
                    } else if (worstPair && lowestPnL < 0) {
                        insight += ` <br><span style="color:#fca5a5; display:inline-block; margin-top:0.4rem;">‚ö†Ô∏è Warning: <strong>${worstPair}</strong> is significantly dragging down your overall P&L. Review these trades.</span>`;
                    } else if (bestPair && highestPnL > 0) {
                        insight += ` <br><span style="color:#86efac; display:inline-block; margin-top:0.4rem;">üéØ <strong>${bestPair}</strong> is your most profitable pair right now. Double down on this setup!</span>`;
                    }

                    aiInsightText.innerHTML = insight;
                }
            }

            // Render Chart.js
            const ctx = document.getElementById('winRateChart').getContext('2d');
            if (winRateChart) {
                winRateChart.destroy();
            }

            const chartData = trueTotal > 0 ? [wins, losses, be] : [0, 0, 1];
            const chartColors = trueTotal > 0 ? ['#10b981', '#ef4444', '#64748b'] : ['#12141f', '#12141f', '#334155'];

            winRateChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Win', 'Loss', 'BE'],
                    datasets: [{
                        data: chartData,
                        backgroundColor: chartColors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: trueTotal > 0 }
                    }
                }
            });

            // Render Equity Curve
            let equityData = [];
            let eqLabels = [];
            let currentEquity = 0;

            if (trades.length > 0) {
                // Initial baseline
                equityData.push(0);
                eqLabels.push('Start');

                // Sort trades chronological
                const sortedTrades = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date));
                sortedTrades.forEach(t => {
                    currentEquity += t.computedPnl;
                    equityData.push(currentEquity);
                    eqLabels.push(t.date);
                });
            } else {
                equityData = [0];
                eqLabels = ['Start'];
            }

            const eqCtx = document.getElementById('equityChart').getContext('2d');
            if (equityChart) {
                equityChart.destroy();
            }

            equityChart = new Chart(eqCtx, {
                type: 'line',
                data: {
                    labels: eqLabels,
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: equityData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#0f111a',
                        pointBorderColor: '#3b82f6',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return '$' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                callback: function (value) { return '$' + value; },
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }
        // Delete functionality using event delegation
        logsContainer.addEventListener('click', function (e) {
            const btn = e.target.closest('.delete-btn');
            if (btn) {
                const tradeId = Number(btn.getAttribute('data-id'));
                if (confirm('Are you sure you want to delete this trade log?')) {
                    trades = trades.filter(t => Number(t.id) !== tradeId);
                    localStorage.setItem(storageKey, JSON.stringify(trades));
                    renderLogs();
                }
            }
        });

        function renderLogs() {
            // Clear current display (except empty state which we will hide/show)
            logsContainer.innerHTML = '';

            updateDashboard();

            if (trades.length === 0) {
                logsContainer.appendChild(emptyState);
                emptyState.style.display = 'block';
                logCount.innerText = '0';
                return;
            }

            emptyState.style.display = 'none';
            logCount.innerText = trades.length;

            // Render trades (newest first)
            trades.slice().reverse().forEach((trade) => {
                const card = document.createElement('div');
                card.style.background = '#12141f';
                card.style.border = '1px solid rgba(255,255,255,0.05)';
                card.style.borderRadius = '12px';
                card.style.padding = '1.5rem';

                let resultColor = '#64748b';
                let resultBg = 'rgba(100, 116, 139, 0.1)';
                if (trade.result === 'WIN') {
                    resultColor = '#10b981';
                    resultBg = 'rgba(16, 185, 129, 0.1)';
                } else if (trade.result === 'LOSS') {
                    resultColor = '#ef4444';
                    resultBg = 'rgba(239, 68, 68, 0.1)';
                }

                let dirColor = trade.direction === 'LONG' ? '#3b82f6' : '#f59e0b';

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 1rem;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.3rem;">
                                <span style="font-weight: 800; color: #fff; font-size: 1.1rem;">${trade.pair}</span>
                                <span style="background: ${trade.direction === 'LONG' ? 'rgba(59, 130, 246, 0.15)' : 'rgba(245, 158, 11, 0.15)'}; color: ${dirColor}; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.75rem; font-weight: 700;">${trade.direction}</span>
                                <span style="color: #64748b; font-size: 0.85rem;">${trade.date}</span>
                            </div>
                            <div style="color: #94a3b8; font-size: 0.9rem;">Trend: <strong>${trade.setup}</strong></div>
                        </div>
                        <div style="text-align: right; position: relative;">
                            <div style="background: ${resultBg}; color: ${resultColor}; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 800; font-size: 0.9rem; display: inline-block;">
                                ${trade.result}
                            </div>
                            <button class="delete-btn" data-id="${trade.id}" style="background: transparent; border: none; color: #64748b; cursor: pointer; font-size: 1rem; margin-left: 0.5rem; padding: 0 0.5rem;" title="Delete log">üóëÔ∏è</button>
                            <div style="margin-top: 0.4rem; font-size: 0.9rem; color: #e2e8f0; font-weight: 600;">
                                ${trade.computedPnl >= 0 ? '+$' + trade.computedPnl : '-$' + Math.abs(trade.computedPnl)} ${trade.rr ? `(${trade.rr}R)` : ''}
                            </div>
                        </div>
                    </div>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.5;">
                        <span style="color: #64748b; font-size: 0.8rem; text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 0.2rem;">Notes</span>
                        ${trade.notes || 'No notes provided.'}
                    </div>
                `;
                logsContainer.appendChild(card);
            });
        }

        journalForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const inputDate = document.getElementById('tradeDate').value;

            // Overtrading Hard Block Logic
            const maxTradesKey = `tradeblitz_max_trades_${userEmail}`;
            const maxTradesConfig = Number(localStorage.getItem(maxTradesKey)) || 3;

            const tradesOnThisDate = trades.filter(t => t.date === inputDate).length;
            if (tradesOnThisDate >= maxTradesConfig) {
                alert(`üõë OVERTRADING BLOCK INTERVENTION\n\nYou have already reached your maximum limit of ${maxTradesConfig} trades for this date.\n\nProtect your edge, preserve your mental capital, and step away from the charts. The market will be here tomorrow.`);
                return; // Stop execution, do not save to backend/localStorage
            }

            const newTrade = {
                id: Date.now(),
                date: document.getElementById('tradeDate').value,
                pair: document.getElementById('tradePair').value,
                direction: document.getElementById('tradeDirection').value,
                setup: document.getElementById('tradeSetup').value,
                result: document.getElementById('tradeResult').value,
                rr: document.getElementById('tradeRR').value,
                pnl: document.getElementById('tradePnL').value,
                notes: document.getElementById('tradeNotes').value
            };

            trades.push(newTrade);
            localStorage.setItem(storageKey, JSON.stringify(trades));

            // Reset form details (keep date)
            const dateVal = document.getElementById('tradeDate').value;
            journalForm.reset();
            document.getElementById('tradeDate').value = dateVal;

            renderLogs();
        });

        // Add logic to save journal to CSV
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        if (downloadCsvBtn) {
            downloadCsvBtn.addEventListener('click', function () {
                if (trades.length === 0) {
                    alert("No trades to save yet. Please log some trades first!");
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "ID,Date,Pair,Direction,Trend,Result,RR Achieved,P&L,Notes\n";

                trades.forEach(function (trade) {
                    let escapedNotes = trade.notes ? trade.notes.replace(/"/g, '""') : '';
                    if (escapedNotes.includes(',') || escapedNotes.includes('\\n') || escapedNotes.includes('"')) {
                        escapedNotes = `"${escapedNotes}"`;
                    }

                    let row = [
                        trade.id,
                        trade.date,
                        trade.pair,
                        trade.direction,
                        trade.setup,
                        trade.result,
                        trade.rr || 0,
                        trade.pnl || 0,
                        escapedNotes
                    ];
                    csvContent += row.join(",") + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "TradeBlitz_Journal.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        // Initial render
        renderLogs();
    </script>
    <!-- Admin Login Modal -->
    <div id="adminModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
        <div class="glass-panel"
            style="background: #0b0d17; padding: 2.5rem; border-radius: 16px; width: 100%; max-width: 400px; border-top: 4px solid #f59e0b; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h3 style="color: #fff; font-family: var(--font-heading); font-size: 1.5rem; margin: 0;">Admin Login
                </h3>
                <button onclick="document.getElementById('adminModal').style.display='none'"
                    style="background: transparent; border: none; color: #64748b; font-size: 2rem; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Admin
                    ID</label>
                <input type="email" id="adminId" placeholder="Admin ID"
                    style="width: 100%; padding: 1rem; background: #05060a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; margin-top: 0.5rem; outline: none; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 2rem;">
                <label
                    style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Password</label>
                <input type="password" id="adminPass" placeholder="Password"
                    style="width: 100%; padding: 1rem; background: #05060a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; margin-top: 0.5rem; outline: none; box-sizing: border-box;">
            </div>

            <button onclick="adminLogin()"
                style="width: 100%; background: #f59e0b; color: #000; font-weight: 800; border: none; padding: 1.2rem; border-radius: 8px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;">Access
                Dashboard</button>
            <div id="adminError"
                style="color: #ef4444; font-size: 0.85rem; margin-top: 1rem; text-align: center; display: none;">Invalid
                ID or Password.</div>
        </div>
    </div>

    <script>
        function adminLogin() {
            const id = document.getElementById('adminId').value.trim();
            const pass = document.getElementById('adminPass').value.trim();

            if (id === 'akshaypayakkal@gmail.com' && pass === '111198125') {
                window.location.href = 'admin.html';
            } else {
                document.getElementById('adminError').style.display = 'block';
            }
        }
    </script>

    <!-- Ambient BGM Player -->
    <audio id="bgmAudio" loop preload="auto">
        <source src="background.mp3" type="audio/mpeg">
    </audio>
    <button id="bgmToggle" title="Toggle Ambient Music" style="position: fixed; bottom: 20px; left: 20px; z-index: 9999; background: rgba(11, 13, 23, 0.8); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(10px); transition: 0.3s; color: #64748b;">
        <svg id="bgmIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <line id="muteLine1" x1="23" y1="9" x2="17" y2="15"></line>
            <line id="muteLine2" x1="17" y1="9" x2="23" y2="15"></line>
        </svg>
    </button>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const audio = document.getElementById("bgmAudio");
            const toggleBtn = document.getElementById("bgmToggle");
            const icon = document.getElementById("bgmIcon");
            
            audio.volume = 0.4; // Default half volume

            // Restore time & play state across pages
            const savedTime = localStorage.getItem("tradeblitz_bgm_time");
            const isPlaying = localStorage.getItem("tradeblitz_bgm_playing") === "true";
            
            if (savedTime) audio.currentTime = parseFloat(savedTime);

            function setPlayingUI() {
                icon.innerHTML = '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>';
                toggleBtn.style.color = "#10b981";
                toggleBtn.style.borderColor = "rgba(16, 185, 129, 0.3)";
                toggleBtn.style.boxShadow = "0 0 10px rgba(16, 185, 129, 0.2)";
            }
            
            function setMutedUI() {
                icon.innerHTML = '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line>';
                toggleBtn.style.color = "#ef4444";
                toggleBtn.style.borderColor = "rgba(239, 68, 68, 0.3)";
                toggleBtn.style.boxShadow = "none";
            }

            if (isPlaying) {
                // Browsers might block this, but we try
                audio.play().then(() => setPlayingUI()).catch(e => setMutedUI());
            } else {
                setMutedUI();
            }
            
            // Save time continuously so jumping pages feels seamless
            setInterval(() => {
                if (!audio.paused) {
                    localStorage.setItem("tradeblitz_bgm_time", audio.currentTime);
                }
            }, 1000);
            
            toggleBtn.addEventListener("click", () => {
                if (audio.paused) {
                    audio.play();
                    setPlayingUI();
                    localStorage.setItem("tradeblitz_bgm_playing", "true");
                } else {
                    audio.pause();
                    setMutedUI();
                    localStorage.setItem("tradeblitz_bgm_playing", "false");
                }
            });
            
            // Try playing anyway on first interaction if they left it playing
            document.body.addEventListener("click", () => {
                if (localStorage.getItem("tradeblitz_bgm_playing") === "true" && audio.paused) {
                    audio.play();
                    setPlayingUI();
                }
            }, { once: true });
        });
    </script>
</body>

</html>