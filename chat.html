<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="TradeBlitz Dashboard - AI Chat">
    <title>AI Chat | TradeBlitz Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;600;800&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="glow-orb orb-1"></div>
    <div class="glow-orb orb-2"></div>
    <div class="grid-overlay"></div>

    <nav id="navbar" class="scrolled">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-text">TradeBlitz Dashboard</span>
            </div>
            <div class="nav-links">
                <a href="prep.html">Daily Prep</a>
                <a href="execute.html">Execute</a>
                <a href="journal.html">Journal</a>
                <a href="tradingclass.html">Trading Class</a>
                <a href="chat.html" class="active" style="color: #fff;">AI Chat</a>
            </div>
            <a href="index.html" class="btn-nav">Log Out</a>
        </div>
    </nav>

    <section class="routine-section" style="padding-top: 10rem; min-height: 100vh;">
        <div class="container">
            <h2 class="section-title">TradeBlitz AI Support ðŸ¤–</h2>
            <p class="section-subtitle">Struggling with a setup? Mindset getting foggy? Talk to your personal trading
                assistant.</p>

            <div class="glass-panel"
                style="margin-top: 3rem; max-width: 800px; margin-left: auto; margin-right: auto; padding: 2rem; border-radius: 16px; background: #0b0d17; display: flex; flex-direction: column; height: 600px;">



                <div id="chatBox"
                    style="flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; padding-right: 0.5rem; margin-bottom: 1.5rem;">

                    <div style="display: flex; gap: 1rem; align-items: flex-start;">
                        <div
                            style="font-size: 1.5rem; background: rgba(59, 130, 246, 0.2); padding: 0.5rem; border-radius: 50%;">
                            ðŸ¤–</div>
                        <div
                            style="background: #12141f; padding: 1rem 1.5rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); color: #e2e8f0; font-size: 0.95rem; line-height: 1.5; border-top-left-radius: 0;">
                            Hello! I am TradeBlitz AI. I am here to help you analyze your setups and master your trading
                            psychology. Notice your emotions shifting? Fire away!
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <input type="text" id="chatInput"
                        placeholder="Ask about trading psychology, strategies, or your latest trade..."
                        style="flex-grow: 1; padding: 1.2rem; background: #05060a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 1rem; outline: none; font-family: 'Inter', sans-serif;">
                    <button id="sendBtn"
                        style="background: #3b82f6; color: #fff; border: none; padding: 0 2rem; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.3s; font-family: 'Inter', sans-serif;">Send</button>
                </div>
            </div>
        </div>
    </section>

    <script>
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatBox = document.getElementById('chatBox');

        let geminiApiKey = 'AIzaSyC6Lis6_C9ZguJfDghirQqa9sZPS3ayvoY';

        function addMessage(text, isUser = false) {
            const msgDiv = document.createElement('div');
            msgDiv.style.display = 'flex';
            msgDiv.style.gap = '1rem';
            msgDiv.style.alignItems = 'flex-start';
            if (isUser) {
                msgDiv.style.flexDirection = 'row-reverse';
            }

            const iconDiv = document.createElement('div');
            iconDiv.style.fontSize = '1.5rem';
            iconDiv.style.padding = '0.5rem';
            iconDiv.style.borderRadius = '50%';

            if (isUser) {
                iconDiv.style.background = 'rgba(16, 185, 129, 0.2)';
                iconDiv.innerText = 'ðŸ‘¤';
            } else {
                iconDiv.style.background = 'rgba(59, 130, 246, 0.2)';
                iconDiv.innerText = 'ðŸ¤–';
            }

            const textDiv = document.createElement('div');
            textDiv.style.background = isUser ? '#10b981' : '#12141f';
            textDiv.style.padding = '1rem 1.5rem';
            textDiv.style.borderRadius = '12px';
            textDiv.style.border = isUser ? 'none' : '1px solid rgba(255,255,255,0.05)';
            textDiv.style.color = isUser ? '#000' : '#e2e8f0';
            textDiv.style.fontSize = '0.95rem';
            textDiv.style.lineHeight = '1.5';
            textDiv.style.fontWeight = isUser ? '600' : '400';

            // Basic markdown handling for bolding
            const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            if (isUser) {
                textDiv.style.borderTopRightRadius = '0';
            } else {
                textDiv.style.borderTopLeftRadius = '0';
            }

            textDiv.innerHTML = formattedText;

            msgDiv.appendChild(iconDiv);
            msgDiv.appendChild(textDiv);

            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function handleSend() {
            const text = chatInput.value.trim();
            if (!text) return;

            if (!geminiApiKey) {
                alert('Please enter and save your Gemini API Key in the top right to use the live AI!');
                return;
            }

            addMessage(text, true);
            chatInput.value = '';

            // Set Loading state
            sendBtn.disabled = true;
            sendBtn.innerHTML = 'Wait...';

            try {
                // Call Gemini 2.5 Flash
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            role: 'user',
                            parts: [{
                                text: `You are a highly disciplined trading psychology coach and technical analysis expert built into the TradeBlitz Dashboard. Your goal is to guide traders strictly, enforce risk management (Max 1% per trade), and offer solid technical/momentum setups on XAUUSD and NQ. Keep your answer under 3 sentences. Be direct, confident, and professional. The trader says: ${text}`
                            }]
                        }]
                    })
                });

                const data = await response.json();

                if (data.error) {
                    addMessage("API Error: " + data.error.message, false);
                } else if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    addMessage(aiText, false);
                } else {
                    addMessage("I am having trouble processing that right now. Please try again.", false);
                }
            } catch (err) {
                addMessage("Connection error. Please check your internet or ensuring your API key is correct.", false);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'Send';
            }
        }

        sendBtn.addEventListener('click', handleSend);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSend();
        });
    </script>
    <!-- Admin Login Modal -->
    <div id="adminModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
        <div class="glass-panel"
            style="background: #0b0d17; padding: 2.5rem; border-radius: 16px; width: 100%; max-width: 400px; border-top: 4px solid #f59e0b; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h3 style="color: #fff; font-family: var(--font-heading); font-size: 1.5rem; margin: 0;">Admin Login
                </h3>
                <button onclick="document.getElementById('adminModal').style.display='none'"
                    style="background: transparent; border: none; color: #64748b; font-size: 2rem; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Admin
                    ID</label>
                <input type="email" id="adminId" placeholder="Admin ID"
                    style="width: 100%; padding: 1rem; background: #05060a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; margin-top: 0.5rem; outline: none; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 2rem;">
                <label
                    style="color: #94a3b8; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Password</label>
                <input type="password" id="adminPass" placeholder="Password"
                    style="width: 100%; padding: 1rem; background: #05060a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; margin-top: 0.5rem; outline: none; box-sizing: border-box;">
            </div>

            <button onclick="adminLogin()"
                style="width: 100%; background: #f59e0b; color: #000; font-weight: 800; border: none; padding: 1.2rem; border-radius: 8px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;">Access
                Dashboard</button>
            <div id="adminError"
                style="color: #ef4444; font-size: 0.85rem; margin-top: 1rem; text-align: center; display: none;">Invalid
                ID or Password.</div>
        </div>
    </div>

    <script>
        function adminLogin() {
            const id = document.getElementById('adminId').value.trim();
            const pass = document.getElementById('adminPass').value.trim();

            if (id === 'akshaypayakkal@gmail.com' && pass === '111198125') {
                window.location.href = 'admin.html';
            } else {
                document.getElementById('adminError').style.display = 'block';
            }
        }
    </script>

    <!-- Ambient BGM Player -->
    <audio id="bgmAudio" loop preload="auto">
        <source src="background.mp3" type="audio/mpeg">
    </audio>
    <button id="bgmToggle" title="Toggle Ambient Music" style="position: fixed; bottom: 20px; left: 20px; z-index: 9999; background: rgba(11, 13, 23, 0.8); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(10px); transition: 0.3s; color: #64748b;">
        <svg id="bgmIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <line id="muteLine1" x1="23" y1="9" x2="17" y2="15"></line>
            <line id="muteLine2" x1="17" y1="9" x2="23" y2="15"></line>
        </svg>
    </button>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const audio = document.getElementById("bgmAudio");
            const toggleBtn = document.getElementById("bgmToggle");
            const icon = document.getElementById("bgmIcon");
            
            audio.volume = 0.4; // Default half volume

            // Restore time & play state across pages
            const savedTime = localStorage.getItem("tradeblitz_bgm_time");
            const isPlaying = localStorage.getItem("tradeblitz_bgm_playing") === "true";
            
            if (savedTime) audio.currentTime = parseFloat(savedTime);

            function setPlayingUI() {
                icon.innerHTML = '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>';
                toggleBtn.style.color = "#10b981";
                toggleBtn.style.borderColor = "rgba(16, 185, 129, 0.3)";
                toggleBtn.style.boxShadow = "0 0 10px rgba(16, 185, 129, 0.2)";
            }
            
            function setMutedUI() {
                icon.innerHTML = '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line>';
                toggleBtn.style.color = "#ef4444";
                toggleBtn.style.borderColor = "rgba(239, 68, 68, 0.3)";
                toggleBtn.style.boxShadow = "none";
            }

            if (isPlaying) {
                // Browsers might block this, but we try
                audio.play().then(() => setPlayingUI()).catch(e => setMutedUI());
            } else {
                setMutedUI();
            }
            
            // Save time continuously so jumping pages feels seamless
            setInterval(() => {
                if (!audio.paused) {
                    localStorage.setItem("tradeblitz_bgm_time", audio.currentTime);
                }
            }, 1000);
            
            toggleBtn.addEventListener("click", () => {
                if (audio.paused) {
                    audio.play();
                    setPlayingUI();
                    localStorage.setItem("tradeblitz_bgm_playing", "true");
                } else {
                    audio.pause();
                    setMutedUI();
                    localStorage.setItem("tradeblitz_bgm_playing", "false");
                }
            });
            
            // Try playing anyway on first interaction if they left it playing
            document.body.addEventListener("click", () => {
                if (localStorage.getItem("tradeblitz_bgm_playing") === "true" && audio.paused) {
                    audio.play();
                    setPlayingUI();
                }
            }, { once: true });
        });
    </script>
</body>

</html>